# B - Beautiful Rotation
https://atcoder.jp/contests/xmascon23/tasks/xmascon23_b

## 問題
平行六面体をある点を中心にランダムな角度だけ回転させた時の $`z`$ 方向のその図形の最大値と最小値の差 $Z$ の期待値を求める。
単位球面ベクトル $`\vec{u}`$ をランダムに選択し、 $`\vec{v} = (0, 0, 1)^T \times \vec{u}`$ を定める。
続いて、
原点と $`\vec{v}`$ を結ぶ直線を回転軸として，点 $`(1,0,0)`$ を $`u`$ へ移動させる回転を行う。
最後に、原点と $`\vec{u}`$ を結ぶ直線を回転軸として， $`[0,2π)`$ から一様に選んだ角度ぶん回転させる。

平行六面体は三つの並行ではない位置ベクトル $`\vec{a}, \vec{b}, \vec{c}`$ （起点 $`(0, 0, 0)`$）を用いて、
$`\vec{0},\, \vec{a},\, \vec{b},\, \vec{c},\, \vec{a}+\vec{b},\, \vec{b}+\vec{c},\, \vec{c}+\vec{a},\, \vec{a}+\vec{b}+\vec{c}`$ の８点で定められる。
この問題では、$`\vec{a} = (A, B, C)^T, \, \vec{b} = (D, E, F)^T, \, \vec{c} = (G, H, I)^T`$ となっている。


## アイデア

八つの頂点をそれぞれ $`p_1, p_2, ..., p_8`$ とする
ランダム回転の結果、$`p_i`$が $`q_i`$ に移動したとする（$`i \in \{1, 2, ..., 8\}`$）。
三つのベクトル $`\vec{a},\, \vec{b},\, \vec{c}`$ に回転を施した後のベクトルをそれぞれ $`\vec{\alpha},\, \vec{\beta},\, \vec{\gamma}`$ とする。


回転後の図形の $`z`$ 座標の最大値を $`M`$ 、最小値を $`m`$ と定義する。
また、表記の定義として、あるベクトル $`\vec{x}`$ の $`z`$ 座標を $`x_z`$ と表すことにする。

### 最高点、最低点の候補
結論としては、

「**最高点/最低点は回転後の 8 つの頂点のいずれかに限られる**」


以下で証明する。
背理法による。もし仮に回転後の 8 つの頂点のいずれでもなかったと仮定する。その点を $`X`$ とし、それが頂点 $`q_a, q_b`$ の間の辺上にあるとする。
すると$`X`$ から $`q_a`$ or $`q_b`$ の方向に微小量移動すると、その点は $`X`$ よりも $`z`$ 座標が大きいか小さいか等しいかの３通りある。
等しいような場合（つまり $`q_a`$ と $`q_b`$ の $`z`$ 座標が等しい場合）は矛盾は生じないが、そうでない場合も当然存在する。
実際に等しくないような場合だと、$`X`$ よりも $`q_a`$ あるいは $`q_b`$ の方が $`z`$ 座標が大きい/小さい。
これは仮説に矛盾する。この時点で背理法により、題意は証明された。


### 観察
回転後の図形の $`z`$ 座標の最大値を $`M`$ 、最小値を $`m`$ と定義したことに注意する。
すると、

```math
(M, m) \in \{
q_i \,| \, i = 1, 2, ..., 8
\}^2
```

ということが前のセクションで示された。



また、$`i = 1, 2, ..., 8`$ に対して、$`\vec{a},\, \vec{b}, \, \vec{c}`$ を回転させた後のベクトル $`\vec{\alpha},\, \vec{\beta},\, \vec{\gamma}`$ を用いて、

```math
\vec{q_i} = s_i \vec{\alpha} + t_i \vec{\beta} + u_i \vec{\gamma} \quad \text{where} (s_i, t_i, u_i)　\in \{0, 1\}^3
```

が成立する。
このことから、
```math
(M, m) \in \{
s \alpha_z + t \beta_z + u \gamma_z \,| \, (s,t,u) \in \{0, 1\}^3
\}^2
```

また、さらに
```math
M = \max (\{
s \alpha_z + t \beta_z + u \gamma_z \,| \, (s,t,u) \in \{0, 1\}^3
\}^2)\\
```

```math
m = \min  (\{
s \alpha_z + t \beta_z + u \gamma_z \,| \, (s,t,u) \in \{0, 1\}^3
\}^2)
```

である。これは自明に、
```math
M = \max (\alpha_z, 0)  + \max (\beta_z, 0) + \max (\gamma_z, 0), 
\,\, 
m = \min (\alpha_z, 0)  + \min (\beta_z, 0) + \min (\gamma_z, 0)
```
と書き換えることができる。よって高さ $`Z`$ は、

```math
\begin{align}
Z 
& = M - m \\
& = (\max (\alpha_z, 0)  + \max (\beta_z, 0) + \max (\gamma_z, 0)) -  (\min (\alpha_z, 0)  + \min (\beta_z, 0) + \min (\gamma_z, 0)) \\
& = (\max (\alpha_z, 0) - \min (\alpha_z, 0))  + (\max (\beta_z, 0) - \min (\beta_z, 0)) + (\max (\gamma_z, 0) - \min (\gamma_z, 0)) \\
& = | \alpha_z | + |\beta_z| + |\gamma_z|
\end{align}
```

となる。

これの期待値を求めたい。つまり、ベクトル $`\vec{a}, \vec{b}, \vec{c}`$ をランダムに回転させた後のそれぞれのベクトルの $`z`$ 成分の絶対値の和の期待値を求めたい。
まずは $`|\alpha_z|`$ の期待値を求める。$`z`$　座標の値しか見ないので、平面 $`y = 0`$（$`x`$ 軸と $`z`$ 軸の二軸の面）で切った二次元平面だけ考えれば良い。
そうすると、$`z`$ 座標は $`[0, |\alpha|]`$ 区間を一様に分布する。従って期待値は、$`\dfrac{1}{2} |\alpha|`$ となる。
同様に、
```math
\begin{align}
E[|\beta_z|] &= \dfrac{1}{2} |\beta| \\
E[|\gamma_z|] &= \dfrac{1}{2} |\gamma|
\end{align}
```

従って、
```math
E[Z]
& = \dfrac{1}{2} |\alpha| + \dfrac{1}{2} |\beta| + \dfrac{1}{2} |\gamma|
& = \dfrac{1}{2} ( |\alpha| + |\beta| + |\gamma| )
```




